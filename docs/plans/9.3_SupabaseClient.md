# Plan 9.3: Supabase Client Configuration

## Summary

Configure the Supabase JavaScript client for the mobile frontend, integrate Expo SecureStore for secure token storage, set up environment variables, and create the authentication service layer. This enables secure communication with the Supabase backend and proper session management.

## Affected Feature Slices

- **Frontend/Services**: Supabase client initialization
- **Frontend/Store**: Authentication state foundation
- **Common**: Environment configuration

## Prerequisites

- Plan 9.1: Expo Project Initialization (completed)
- Supabase project created with Auth enabled
- Backend API ready (or at least Supabase URL and anon key available)

## Implementation Steps

### 1. Install Dependencies

```bash
cd Stepper.Mobile

# Supabase client
npm install @supabase/supabase-js

# Secure storage for tokens
npx expo install expo-secure-store

# Environment variables
npm install react-native-dotenv
npm install --save-dev @types/react-native-dotenv

# AsyncStorage for non-sensitive data
npx expo install @react-native-async-storage/async-storage
```

### 2. Configure Environment Variables

Create `.env` file (not committed):

```
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your-anon-key-here
API_BASE_URL=http://localhost:5000/api
```

Update `.env.example`:

```
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your-anon-key
API_BASE_URL=http://localhost:5000/api
```

### 3. Configure TypeScript for Environment Variables

Create `src/types/env.d.ts`:

```typescript
declare module '@env' {
  export const SUPABASE_URL: string;
  export const SUPABASE_ANON_KEY: string;
  export const API_BASE_URL: string;
}
```

Update `babel.config.js` to include environment variables plugin:

```javascript
module.exports = function(api) {
  api.cache(true);
  return {
    presets: ['babel-preset-expo'],
    plugins: [
      [
        'module-resolver',
        {
          // ... existing path aliases
        },
      ],
      [
        'module:react-native-dotenv',
        {
          moduleName: '@env',
          path: '.env',
          safe: false,
          allowUndefined: true,
        },
      ],
    ],
  };
};
```

### 4. Create SecureStore Adapter

Create `src/services/secureStore.ts`:

```typescript
import * as SecureStore from 'expo-secure-store';
import { Platform } from 'react-native';

/**
 * Expo SecureStore adapter for Supabase auth storage
 * Provides secure token storage on both iOS and Android
 */
export const ExpoSecureStoreAdapter = {
  getItem: async (key: string): Promise<string | null> => {
    try {
      return await SecureStore.getItemAsync(key);
    } catch (error) {
      console.error('SecureStore getItem error:', error);
      return null;
    }
  },

  setItem: async (key: string, value: string): Promise<void> => {
    try {
      await SecureStore.setItemAsync(key, value);
    } catch (error) {
      console.error('SecureStore setItem error:', error);
      throw error;
    }
  },

  removeItem: async (key: string): Promise<void> => {
    try {
      await SecureStore.deleteItemAsync(key);
    } catch (error) {
      console.error('SecureStore removeItem error:', error);
      throw error;
    }
  },
};

/**
 * Check if secure storage is available on the device
 */
export const isSecureStoreAvailable = async (): Promise<boolean> => {
  try {
    if (Platform.OS === 'web') {
      return false;
    }
    await SecureStore.setItemAsync('test', 'test');
    await SecureStore.deleteItemAsync('test');
    return true;
  } catch {
    return false;
  }
};
```

### 5. Create Supabase Client

Create `src/services/supabase.ts`:

```typescript
import { createClient } from '@supabase/supabase-js';
import { SUPABASE_URL, SUPABASE_ANON_KEY } from '@env';
import { ExpoSecureStoreAdapter } from './secureStore';

/**
 * Supabase client configured for Expo with secure token storage
 */
export const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: {
    storage: ExpoSecureStoreAdapter,
    autoRefreshToken: true,
    persistSession: true,
    detectSessionInUrl: false,
  },
});

/**
 * Get the current session
 */
export const getSession = async () => {
  const { data, error } = await supabase.auth.getSession();
  if (error) {
    console.error('Error getting session:', error);
    return null;
  }
  return data.session;
};

/**
 * Get the current user
 */
export const getCurrentUser = async () => {
  const { data, error } = await supabase.auth.getUser();
  if (error) {
    console.error('Error getting user:', error);
    return null;
  }
  return data.user;
};

/**
 * Sign in with email and password
 */
export const signInWithEmail = async (email: string, password: string) => {
  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password,
  });

  if (error) throw error;
  return data;
};

/**
 * Sign up with email and password
 */
export const signUpWithEmail = async (
  email: string,
  password: string,
  displayName: string
) => {
  const { data, error } = await supabase.auth.signUp({
    email,
    password,
    options: {
      data: {
        display_name: displayName,
      },
    },
  });

  if (error) throw error;
  return data;
};

/**
 * Sign out
 */
export const signOut = async () => {
  const { error } = await supabase.auth.signOut();
  if (error) throw error;
};

/**
 * Reset password
 */
export const resetPassword = async (email: string) => {
  const { error } = await supabase.auth.resetPasswordForEmail(email, {
    redirectTo: 'Stepper://reset-password',
  });

  if (error) throw error;
};
```

### 6. Create Configuration File

Create `src/config/supabase.config.ts`:

```typescript
import { SUPABASE_URL, SUPABASE_ANON_KEY, API_BASE_URL } from '@env';

export const supabaseConfig = {
  url: SUPABASE_URL,
  anonKey: SUPABASE_ANON_KEY,
};

export const apiConfig = {
  baseUrl: API_BASE_URL,
  timeout: 30000, // 30 seconds
};

/**
 * Validate that required environment variables are set
 */
export const validateConfig = (): boolean => {
  if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
    console.error('Missing required Supabase configuration');
    return false;
  }

  if (!API_BASE_URL) {
    console.warn('API_BASE_URL not set, API calls may fail');
  }

  return true;
};
```

### 7. Create Auth Context/Hook (Optional)

Create `src/hooks/useSupabaseAuth.ts`:

```typescript
import { useEffect, useState } from 'react';
import { Session, User } from '@supabase/supabase-js';
import { supabase } from '@services/supabase';

export const useSupabaseAuth = () => {
  const [session, setSession] = useState<Session | null>(null);
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Get initial session
    supabase.auth.getSession().then(({ data: { session } }) => {
      setSession(session);
      setUser(session?.user ?? null);
      setLoading(false);
    });

    // Listen for auth changes
    const {
      data: { subscription },
    } = supabase.auth.onAuthStateChange((_event, session) => {
      setSession(session);
      setUser(session?.user ?? null);
    });

    return () => subscription.unsubscribe();
  }, []);

  return {
    session,
    user,
    loading,
    signOut: () => supabase.auth.signOut(),
  };
};
```

### 8. Update .gitignore

Ensure `.env` is ignored:

```
# Environment
.env
.env.local
.env.*.local
```

### 9. Initialize Config on App Start

Update `App.tsx` to validate configuration:

```typescript
import { useEffect } from 'react';
import { validateConfig } from '@config/supabase.config';

export default function App() {
  useEffect(() => {
    if (!validateConfig()) {
      console.error('Invalid app configuration');
    }
  }, []);

  // Rest of app...
}
```

## Database Changes

None. This plan configures the client to connect to existing Supabase backend.

## Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| @supabase/supabase-js | ^2.x | Supabase client library |
| expo-secure-store | Latest | Secure token storage |
| react-native-dotenv | ^3.x | Environment variable support |
| @react-native-async-storage/async-storage | Latest | Non-sensitive storage |

## Security Considerations

1. **Token Storage**:
   - Auth tokens stored in SecureStore (encrypted)
   - SecureStore uses Keychain (iOS) and KeyStore (Android)
   - Never store tokens in AsyncStorage (not encrypted)

2. **Environment Variables**:
   - Never commit `.env` file
   - Use `.env.example` as template
   - Supabase anon key is public but RLS protects data

3. **Session Management**:
   - Auto-refresh tokens enabled
   - Session persists across app restarts
   - Tokens expire after configured time

## Tests

**Unit Tests** (Jest):
```typescript
describe('Supabase Client', () => {
  it('should create client with correct config', () => {
    expect(supabase).toBeDefined();
  });

  it('should have auth methods', () => {
    expect(typeof signInWithEmail).toBe('function');
    expect(typeof signUpWithEmail).toBe('function');
    expect(typeof signOut).toBe('function');
  });
});

describe('SecureStore Adapter', () => {
  it('should store and retrieve items', async () => {
    await ExpoSecureStoreAdapter.setItem('test', 'value');
    const value = await ExpoSecureStoreAdapter.getItem('test');
    expect(value).toBe('value');
    await ExpoSecureStoreAdapter.removeItem('test');
  });
});
```

**Integration Tests**:
- Sign in with valid credentials
- Sign out successfully
- Session persists across app restart
- Tokens refresh automatically

## Acceptance Criteria

- [ ] Supabase JS client installed and configured
- [ ] SecureStore adapter implemented
- [ ] Environment variables configured (.env, .env.example)
- [ ] TypeScript types for environment variables
- [ ] Supabase client exports all auth methods
- [ ] Configuration validation on app start
- [ ] .env file ignored in git
- [ ] Auth session listener implemented
- [ ] Tokens stored securely in SecureStore
- [ ] Auto-refresh tokens enabled
- [ ] Session persists across app restarts
- [ ] Can sign in, sign up, and sign out
- [ ] Error handling for auth failures

## Dependencies on Other Plans

**Requires**:
- Plan 9.1: Expo Project Initialization (project structure exists)

**Blocks**:
- Plan 9.5: State Management (auth store needs Supabase client)
- Plan 10: Auth Screens (UI needs auth functions)
- All data-fetching features (need authenticated client)

## Risks and Mitigations

| Risk | Mitigation |
|------|------------|
| Supabase URL/key exposed | Anon key is public; RLS protects data |
| SecureStore not available | Check availability, fallback to AsyncStorage with warning |
| Token refresh failures | Implement retry logic with exponential backoff |
| Network errors | Catch and display user-friendly errors |
| Session out of sync | Subscribe to auth state changes |

## Configuration Checklist

Before running the app:
- [ ] Create Supabase project
- [ ] Enable Email Auth in Supabase dashboard
- [ ] Copy Supabase URL from dashboard
- [ ] Copy anon key from dashboard
- [ ] Create `.env` file with values
- [ ] Test connection to Supabase

## Notes

- This plan focuses solely on Supabase client setup
- State management integration happens in Plan 9.5
- API service wrappers for data fetching happen in Plan 9.5
- Deep linking for auth redirects handled in Plan 9.4

