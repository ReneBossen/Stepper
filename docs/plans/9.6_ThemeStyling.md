# Plan 9.6: Theme & Styling

## Summary

Set up React Native Paper for UI components, configure light and dark themes, implement theme switching based on user preferences, and create the final App.tsx entry point that integrates all providers (navigation, theme, safe area). This completes the frontend foundation.

## Affected Feature Slices

- **Frontend/Theme**: Theme configuration and switching
- **Frontend/App**: Root App.tsx with all providers

## Prerequisites

- Plan 9.1: Expo Project Initialization
- Plan 9.3: Supabase Client Configuration
- Plan 9.4: Navigation Structure
- Plan 9.5: State Management

## Implementation Steps

### 1. Install Dependencies

```bash
cd WalkingApp.Mobile

# UI Components
npm install react-native-paper

# Icons
npx expo install @expo/vector-icons

# Safe Area
npx expo install react-native-safe-area-context

# Status Bar
npx expo install expo-status-bar
```

### 2. Configure Theme Colors

Create `src/theme/colors.ts`:

```typescript
export const colors = {
  light: {
    primary: '#4CAF50',        // Green for walking/activity
    primaryContainer: '#81C784',
    secondary: '#2196F3',      // Blue for accents
    secondaryContainer: '#64B5F6',
    tertiary: '#FF9800',       // Orange for achievements
    tertiaryContainer: '#FFB74D',
    
    background: '#FAFAFA',
    surface: '#FFFFFF',
    surfaceVariant: '#F5F5F5',
    
    error: '#F44336',
    errorContainer: '#FFCDD2',
    
    onPrimary: '#FFFFFF',
    onPrimaryContainer: '#1B5E20',
    onSecondary: '#FFFFFF',
    onSecondaryContainer: '#0D47A1',
    onTertiary: '#FFFFFF',
    onTertiaryContainer: '#E65100',
    onBackground: '#212121',
    onSurface: '#212121',
    onSurfaceVariant: '#757575',
    onError: '#FFFFFF',
    onErrorContainer: '#B71C1C',
    
    outline: '#E0E0E0',
    outlineVariant: '#EEEEEE',
    
    shadow: '#000000',
    scrim: '#000000',
    inverseSurface: '#121212',
    inverseOnSurface: '#FAFAFA',
    inversePrimary: '#81C784',
    
    elevation: {
      level0: 'transparent',
      level1: '#FFFFFF',
      level2: '#F5F5F5',
      level3: '#EEEEEE',
      level4: '#E0E0E0',
      level5: '#BDBDBD',
    },
  },
  
  dark: {
    primary: '#81C784',        // Lighter green for dark mode
    primaryContainer: '#388E3C',
    secondary: '#64B5F6',
    secondaryContainer: '#1976D2',
    tertiary: '#FFB74D',
    tertiaryContainer: '#F57C00',
    
    background: '#121212',
    surface: '#1E1E1E',
    surfaceVariant: '#2C2C2C',
    
    error: '#EF5350',
    errorContainer: '#B71C1C',
    
    onPrimary: '#003300',
    onPrimaryContainer: '#C8E6C9',
    onSecondary: '#003366',
    onSecondaryContainer: '#BBDEFB',
    onTertiary: '#4D2C00',
    onTertiaryContainer: '#FFE0B2',
    onBackground: '#E0E0E0',
    onSurface: '#E0E0E0',
    onSurfaceVariant: '#BDBDBD',
    onError: '#4D0000',
    onErrorContainer: '#FFCDD2',
    
    outline: '#424242',
    outlineVariant: '#616161',
    
    shadow: '#000000',
    scrim: '#000000',
    inverseSurface: '#E0E0E0',
    inverseOnSurface: '#121212',
    inversePrimary: '#4CAF50',
    
    elevation: {
      level0: 'transparent',
      level1: '#1E1E1E',
      level2: '#232323',
      level3: '#252525',
      level4: '#272727',
      level5: '#2C2C2C',
    },
  },
};
```

### 3. Create Theme Configuration

Create `src/theme/theme.ts`:

```typescript
import { MD3LightTheme, MD3DarkTheme, MD3Theme } from 'react-native-paper';
import { colors } from './colors';

export const lightTheme: MD3Theme = {
  ...MD3LightTheme,
  colors: colors.light,
  fonts: {
    ...MD3LightTheme.fonts,
  },
  roundness: 8,
};

export const darkTheme: MD3Theme = {
  ...MD3DarkTheme,
  colors: colors.dark,
  fonts: {
    ...MD3DarkTheme.fonts,
  },
  roundness: 8,
};

// Navigation theme integration
export const lightNavigationTheme = {
  dark: false,
  colors: {
    primary: colors.light.primary,
    background: colors.light.background,
    card: colors.light.surface,
    text: colors.light.onBackground,
    border: colors.light.outline,
    notification: colors.light.tertiary,
  },
};

export const darkNavigationTheme = {
  dark: true,
  colors: {
    primary: colors.dark.primary,
    background: colors.dark.background,
    card: colors.dark.surface,
    text: colors.dark.onBackground,
    border: colors.dark.outline,
    notification: colors.dark.tertiary,
  },
};
```

### 4. Create Theme Hook

Create `src/hooks/useAppTheme.ts`:

```typescript
import { useColorScheme } from 'react-native';
import { useUserStore } from '@store/userStore';
import { lightTheme, darkTheme, lightNavigationTheme, darkNavigationTheme } from '@theme/theme';

export const useAppTheme = () => {
  const systemColorScheme = useColorScheme();
  const themePreference = useUserStore(
    (state) => state.currentUser?.preferences?.theme ?? 'system'
  );

  // Determine effective theme
  const effectiveTheme = 
    themePreference === 'system' ? systemColorScheme : themePreference;

  const isDark = effectiveTheme === 'dark';

  return {
    paperTheme: isDark ? darkTheme : lightTheme,
    navigationTheme: isDark ? darkNavigationTheme : lightNavigationTheme,
    isDark,
  };
};
```

### 5. Create Theme Provider Component

Create `src/theme/ThemeProvider.tsx`:

```typescript
import React, { ReactNode } from 'react';
import { PaperProvider } from 'react-native-paper';
import { StatusBar } from 'expo-status-bar';
import { useAppTheme } from '@hooks/useAppTheme';

interface ThemeProviderProps {
  children: ReactNode;
}

export const ThemeProvider: React.FC<ThemeProviderProps> = ({ children }) => {
  const { paperTheme, isDark } = useAppTheme();

  return (
    <PaperProvider theme={paperTheme}>
      <StatusBar style={isDark ? 'light' : 'dark'} />
      {children}
    </PaperProvider>
  );
};
```

### 6. Create Final App.tsx

Update `App.tsx`:

```typescript
import React, { useEffect, useState } from 'react';
import { SafeAreaProvider } from 'react-native-safe-area-context';
import { NavigationContainer } from '@react-navigation/native';
import { ThemeProvider } from '@theme/ThemeProvider';
import { useAppTheme } from '@hooks/useAppTheme';
import RootNavigator from '@navigation/RootNavigator';
import { supabase } from '@services/supabase';
import { useAuthStore } from '@store/authStore';
import { useUserStore } from '@store/userStore';
import { validateConfig } from '@config/supabase.config';
import * as SplashScreen from 'expo-splash-screen';

// Keep splash screen visible while loading
SplashScreen.preventAutoHideAsync();

function AppContent() {
  const { navigationTheme } = useAppTheme();
  const [isReady, setIsReady] = useState(false);
  const setSession = useAuthStore((state) => state.setSession);
  const fetchCurrentUser = useUserStore((state) => state.fetchCurrentUser);

  useEffect(() => {
    async function prepare() {
      try {
        // Validate configuration
        if (!validateConfig()) {
          console.error('Invalid app configuration');
        }

        // Check initial session
        const { data: { session } } = await supabase.auth.getSession();
        setSession(session);

        // Fetch user profile if authenticated
        if (session) {
          await fetchCurrentUser();
        }

        // Setup auth state listener
        const {
          data: { subscription },
        } = supabase.auth.onAuthStateChange(async (event, session) => {
          setSession(session);
          
          if (event === 'SIGNED_IN' && session) {
            await fetchCurrentUser();
          }
        });

        setIsReady(true);
        await SplashScreen.hideAsync();

        // Cleanup
        return () => {
          subscription.unsubscribe();
        };
      } catch (error) {
        console.error('App initialization error:', error);
        setIsReady(true);
        await SplashScreen.hideAsync();
      }
    }

    prepare();
  }, []);

  if (!isReady) {
    return null;
  }

  return (
    <NavigationContainer theme={navigationTheme}>
      <RootNavigator />
    </NavigationContainer>
  );
}

export default function App() {
  return (
    <SafeAreaProvider>
      <ThemeProvider>
        <AppContent />
      </ThemeProvider>
    </SafeAreaProvider>
  );
}
```

### 7. Create Common UI Components

Create `src/components/common/LoadingSpinner.tsx`:

```typescript
import React from 'react';
import { View, StyleSheet } from 'react-native';
import { ActivityIndicator } from 'react-native-paper';

export const LoadingSpinner: React.FC = () => {
  return (
    <View style={styles.container}>
      <ActivityIndicator size="large" />
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
});
```

Create `src/components/common/ErrorMessage.tsx`:

```typescript
import React from 'react';
import { View, StyleSheet } from 'react-native';
import { Text, Button } from 'react-native-paper';

interface ErrorMessageProps {
  message: string;
  onRetry?: () => void;
}

export const ErrorMessage: React.FC<ErrorMessageProps> = ({ message, onRetry }) => {
  return (
    <View style={styles.container}>
      <Text variant="bodyLarge" style={styles.text}>
        {message}
      </Text>
      {onRetry && (
        <Button mode="contained" onPress={onRetry} style={styles.button}>
          Retry
        </Button>
      )}
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 24,
  },
  text: {
    textAlign: 'center',
    marginBottom: 16,
  },
  button: {
    marginTop: 8,
  },
});
```

### 8. Configure App Entry Point

Update `package.json`:

```json
{
  "main": "node_modules/expo/AppEntry.js"
}
```

Ensure `app.json` is configured:

```json
{
  "expo": {
    "userInterfaceStyle": "automatic"
  }
}
```

### 9. Add Theme Switching Logic

Users can switch themes via Settings screen (Plan 19):

```typescript
// In Settings screen
import { useUserStore } from '@store/userStore';

const updateTheme = useUserStore((state) => state.updatePreferences);

const handleThemeChange = async (theme: 'light' | 'dark' | 'system') => {
  await updateTheme({ theme });
  // Theme will automatically update via useAppTheme hook
};
```

## Database Changes

None. Theme preferences stored in users.preferences JSONB column (Plan 8).

## Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| react-native-paper | ^5.x | Material Design 3 components |
| @expo/vector-icons | Latest | Icon library |
| react-native-safe-area-context | Latest | Safe area handling |
| expo-status-bar | Latest | Status bar styling |
| expo-splash-screen | Latest | Splash screen control |

## Tests

**Theme Tests**:
```typescript
describe('Theme', () => {
  it('should return light theme by default', () => {
    const { paperTheme } = useAppTheme();
    expect(paperTheme.dark).toBe(false);
  });

  it('should switch to dark theme when preference is dark', () => {
    // Set user preference to dark
    const { paperTheme } = useAppTheme();
    expect(paperTheme.dark).toBe(true);
  });
});
```

## Acceptance Criteria

- [ ] React Native Paper installed and configured
- [ ] Light theme defined with walking app colors
- [ ] Dark theme defined with appropriate contrast
- [ ] Theme hook uses user preference
- [ ] Theme hook falls back to system theme
- [ ] ThemeProvider wraps app
- [ ] Navigation theme synced with Paper theme
- [ ] StatusBar style matches theme
- [ ] App.tsx integrates all providers in correct order
- [ ] Splash screen shows during initialization
- [ ] Auth state listener set up
- [ ] User profile fetched on sign in
- [ ] Common components (Loading, Error) created
- [ ] Theme switching works without app restart

## Provider Hierarchy

```
App
└── SafeAreaProvider
    └── ThemeProvider (PaperProvider + StatusBar)
        └── NavigationContainer
            └── RootNavigator
                └── Screens
```

## Dependencies on Other Plans

**Requires**:
- Plan 9.1: Expo Project Initialization
- Plan 9.3: Supabase Client Configuration
- Plan 9.4: Navigation Structure
- Plan 9.5: State Management

**Blocks**:
- Plan 10-19: All UI screens (need theme and providers)

## Risks and Mitigations

| Risk | Mitigation |
|------|------------|
| Theme flicker on load | Initialize with system theme |
| Status bar wrong color | Sync StatusBar with theme |
| Provider order incorrect | Document required hierarchy |
| Theme not persisting | Store in user preferences |

## Color Palette Rationale

**Primary Green (#4CAF50)**:
- Represents activity, health, walking
- Positive, encouraging color
- Good contrast in both themes

**Secondary Blue (#2196F3)**:
- Provides contrast to green
- Used for secondary actions
- Professional, trustworthy

**Tertiary Orange (#FF9800)**:
- Achievement, celebration color
- Used for milestones, badges
- Energetic, motivating

## Notes

- Material Design 3 provides excellent accessibility
- Theme automatically updates when user preference changes
- Navigation theme must be separate from Paper theme
- StatusBar style critical for good UX
- Splash screen prevents white flash on load
- All UI screens will use Paper components for consistency

